é€™æ˜¯ä¸€ä»½å®Œå…¨é‡æ–°è¨­è¨ˆçš„å‰ç«¯ä»£ç¢¼ã€‚

### è¨­è¨ˆæ ¸å¿ƒç†å¿µï¼šiOS Native Look (åŸç”Ÿæ„Ÿ)

ç‚ºäº†é”åˆ°ã€Œåƒæ˜¯åŸç”Ÿ Appã€çš„é«”é©—ï¼Œæˆ‘åšäº†ä»¥ä¸‹é‡å¤§çš„ UI/UX æ”¹å‹•ï¼š

1. **åº•éƒ¨å°èˆªæ¬„ (Bottom Tab Bar)**ï¼šå°‡åŸæœ¬åœ¨é ‚éƒ¨çš„ Tab æ”¹ç‚º iOS æ¨™æº–çš„åº•éƒ¨å°èˆªï¼Œé€™æ˜¯ iPhone å–®æ‰‹æ“ä½œçš„æ ¸å¿ƒï¼Œä¸¦åŠ å…¥äº†æ¯›ç»ç’ƒç‰¹æ•ˆã€‚
2. **åº•éƒ¨æŠ½å±œ (Bottom Sheet Modals)**ï¼šå°‡åŸæœ¬ç½®ä¸­çš„å½ˆå‡ºè¦–çª—æ”¹ç‚ºå¾åº•éƒ¨æ»‘å‡ºçš„é¢æ¿ï¼Œé€™æ›´ç¬¦åˆç¾ä»£ iOS çš„æ“ä½œé‚è¼¯ã€‚
3. **å¤§æ¨™é¡Œ (Large Title)**ï¼šæ¡ç”¨ iOS è¨­å®šé é¢çš„å¤§æ¨™é¡Œé¢¨æ ¼ï¼Œè®“å±¤ç´šæ›´åˆ†æ˜ã€‚
4. **å¡ç‰‡å¼è¨­è¨ˆ (Inset Grouped)**ï¼šå…§å®¹å€å¡Šæ¡ç”¨åœ“è§’å¡ç‰‡ï¼ŒèƒŒæ™¯ä½¿ç”¨æ¥µæ·¡çš„ç°è—è‰²ï¼Œè®“è¦–è¦ºæ›´ä¹¾æ·¨ï¼Œä¸å†éåº¦ä¾è³´æ·±è‰²é™°å½±ã€‚
5. **è§¸è¦ºå„ªåŒ–**ï¼šæŒ‰éˆ•ã€è¼¸å…¥æ¡†çš„é«˜åº¦èˆ‡é»æ“Šç¯„åœéƒ½é‡å°æ‰‹æŒ‡è§¸æ§é€²è¡Œäº†å„ªåŒ–ã€‚

åŠŸèƒ½é‚è¼¯ï¼ˆVue.js éƒ¨åˆ†ï¼‰å®Œå…¨ä¿ç•™ï¼Œåƒ…é‡å° UI çµæ§‹é€²è¡Œèª¿æ•´ã€‚æ‚¨å¯ä»¥ç›´æ¥è¤‡è£½è²¼ä¸Šè¦†è“‹åŸæœ¬çš„æª”æ¡ˆã€‚

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>2026æŒªå¨å†°å³¶ä¹‹æ—…</title>
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="2026æ—…ç¨‹">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f2f2f7">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/snowflake.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* iOS Native Look Variables */
    :root {
      --ios-bg: #f2f2f7;
      --ios-card-bg: #ffffff;
      --ios-blue: #007AFF;
      --ios-gray-text: #8E8E93;
      --ios-separator: #C6C6C8;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", "Noto Sans TC", sans-serif;
      background-color: var(--ios-bg);
      color: #000;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Layout Structure */
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }

    /* Dynamic Header with Blur */
    .ios-header {
      padding-top: max(10px, var(--safe-top));
      padding-bottom: 10px;
      padding-left: 16px;
      padding-right: 16px;
      background: rgba(242, 242, 247, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 40;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
    }

    /* Scrollable Area */
    .scrollable-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding-bottom: calc(90px + var(--safe-bottom)); /* Make space for bottom tab */
      background-color: var(--ios-bg);
    }
    
    .scrollable-content::-webkit-scrollbar { display: none; }

    /* Bottom Tab Bar */
    .bottom-tab-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: calc(50px + var(--safe-bottom));
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 0.5px solid rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      padding-top: 8px;
      z-index: 50;
    }

    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      width: 60px;
      color: #999;
      font-size: 10px;
      font-weight: 500;
      transition: color 0.2s;
    }
    .tab-item.active { color: var(--ios-blue); }
    .tab-icon { width: 24px; height: 24px; fill: currentColor; }

    /* iOS Cards */
    .ios-card {
      background: var(--ios-card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .ios-list-group {
      background: var(--ios-card-bg);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    
    .ios-list-item {
      padding: 12px 16px;
      border-bottom: 0.5px solid rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
    }
    .ios-list-item:last-child { border-bottom: none; }
    .ios-list-item:active { background-color: #f2f2f7; }

    /* Inputs */
    .ios-input-group {
      background: rgba(118, 118, 128, 0.12);
      border-radius: 10px;
      display: flex;
      align-items: center;
      padding: 0 12px;
      height: 36px;
      margin-bottom: 8px;
    }
    .ios-input {
      background: transparent;
      border: none;
      outline: none;
      width: 100%;
      font-size: 16px; /* Prevents auto-zoom on iOS */
      color: #000;
    }
    select.ios-input { -webkit-appearance: none; background: transparent; }

    /* Buttons */
    .ios-btn {
      background: var(--ios-blue);
      color: white;
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
      text-align: center;
      width: 100%;
      font-size: 16px;
      transition: opacity 0.2s;
    }
    .ios-btn:active { opacity: 0.7; }
    .ios-btn-secondary {
      background: rgba(118, 118, 128, 0.12);
      color: var(--ios-blue);
    }
    .ios-btn-danger { background: #FF3B30; color: white; }

    /* Date Slider */
    .date-scroll {
      display: flex;
      overflow-x: auto;
      gap: 8px;
      padding: 8px 16px;
      background: var(--ios-bg);
      scrollbar-width: none;
    }
    .date-scroll::-webkit-scrollbar { display: none; }
    .date-chip {
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 60px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }
    .date-chip.selected {
      background: var(--ios-blue);
      color: white;
      box-shadow: 0 4px 10px rgba(0,122,255,0.3);
      transform: scale(1.05);
    }

    /* Bottom Sheet Modal */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 100;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    
    .bottom-sheet {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: #fff;
      border-radius: 24px 24px 0 0;
      padding: 20px;
      padding-bottom: calc(20px + var(--safe-bottom));
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-overlay.active .bottom-sheet { transform: translateY(0); }

    /* Utilities */
    .pull-indicator {
      text-align: center; font-size: 12px; color: #8E8E93; 
      height: 0; overflow: hidden; transition: height 0.2s;
      display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px;
    }
    .skeleton {
      background: linear-gradient(90deg, #e5e5ea 25%, #d1d1d6 50%, #e5e5ea 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    .allow-select { user-select: text; -webkit-user-select: text; }
    .pending-sync { border-left: 3px solid #FF9500; }

    /* Image Viewer */
    .img-viewer-overlay {
        position: fixed; inset: 0; z-index: 9999;
        background: #000; 
        display: flex; justify-content: center; align-items: center;
        flex-direction: column;
        transition: background 0.2s;
    }
    .img-viewer-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .img-viewer-close {
        position: absolute; top: 40px; right: 20px;
        width: 36px; height: 36px; background: rgba(255,255,255,0.2);
        color: white; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        z-index: 10000; font-size: 20px;
    }
  </style>
</head>
<body>

<div id="app">
  <div class="pull-indicator" :style="{ height: pullDistance + 'px' }">
    <span v-if="pullDistance > 20">{{ refreshText }}</span>
  </div>

  <div class="ios-header">
    <div class="flex justify-between items-end pb-1">
      <div>
        <div class="text-[11px] font-bold text-[#8E8E93] uppercase tracking-wide">{{ todayDate }} Â· {{ todayWeekday }}</div>
        <h1 class="text-[34px] font-bold leading-tight tracking-tight text-black">
          {{ tab === 'itinerary' ? 'æ—…ç¨‹' : (tab === 'expense' ? 'è¨˜å¸³' : 'åˆ†æ') }}
        </h1>
      </div>
      <div class="flex flex-col items-end gap-1">
         <span v-if="!isOnline" class="bg-gray-500 text-white px-2 py-0.5 rounded text-[10px] font-bold">é›¢ç·š</span>
         <span v-if="isSyncing" class="text-[10px] font-bold text-blue-500 animate-pulse">åŒæ­¥ä¸­...</span>
         <button v-else-if="syncQueue.length > 0" @click="confirmClearSync" 
                 class="bg-orange-500 text-white px-2 py-0.5 rounded-full text-[10px] font-bold">
            å¾…å‚³ ({{syncQueue.length}})
         </button>
         <span v-if="tripStatus" class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold">{{ tripStatus }}</span>
      </div>
    </div>
  </div>

  <div class="scrollable-content px-4 pt-2" ref="scrollContainer">
    
    <div v-if="tab==='itinerary'">
      <div class="-mx-4 mb-4">
         <div ref="dateContainer" class="date-scroll swipe-protected">
            <div v-for="d in tripDates" :key="d.date" :id="'date-btn-' + d.date" @click="selectDate(d.date)"
                 :class="['date-chip', selDate===d.date ? 'selected' : '']">
               <span class="text-[10px] opacity-60 font-bold uppercase">{{ new Date(d.date).toLocaleString('en-us', {weekday:'short'}) }}</span>
               <span class="text-lg font-bold leading-none mt-1">{{ new Date(d.date).getDate() }}</span>
            </div>
         </div>
      </div>

      <div class="flex justify-between items-center mb-2 px-1">
         <h2 class="text-lg font-bold text-gray-800">{{ getDayInfo(selDate).split('Â·')[0] }}</h2>
         <span class="text-xs text-gray-500 font-medium">{{ getDayInfo(selDate).split('Â·')[1] }}</span>
      </div>

      <div v-if="isLoading && itinerary.length===0" class="space-y-3">
         <div v-for="i in 3" :key="i" class="h-24 skeleton w-full"></div>
      </div>

      <div v-else class="pb-10">
         <div v-for="evt in getEvents(selDate)" :key="evt.row" 
              :class="['ios-card flex gap-4 relative overflow-hidden active:scale-[0.99] transition-transform', isItemPending(evt.row) ? 'pending-sync' : '']"
              @click="openEditItin(evt)">
            
            <div class="flex flex-col items-center min-w-[3rem] border-r border-gray-100 pr-3">
               <span class="text-sm font-semibold text-gray-900">{{ evt.startTime }}</span>
               <span class="text-[10px] text-gray-400 mt-1">{{ evt.endTime }}</span>
               <span :class="['mt-2 text-[9px] px-1.5 py-0.5 rounded font-bold', 
                  evt.category==='äº¤é€š'?'bg-blue-50 text-blue-600':
                  evt.category==='ä½å®¿'?'bg-yellow-50 text-yellow-600':
                  evt.category==='é£²é£Ÿ'?'bg-orange-50 text-orange-600':
                  'bg-gray-100 text-gray-500']">{{ evt.category }}</span>
            </div>

            <div class="flex-1 min-w-0">
               <div class="flex justify-between items-start">
                  <h3 class="font-semibold text-gray-900 leading-snug truncate">{{ evt.title }}</h3>
               </div>
               
               <div v-if="evt.location" class="flex items-center gap-1 mt-1">
                  <span class="text-xs text-gray-500 truncate">ğŸ“ {{ evt.location }}</span>
                  <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(evt.location)" target="_blank"
                     class="text-[10px] bg-gray-100 text-blue-500 px-2 py-0.5 rounded ml-auto flex-shrink-0 swipe-protected" @click.stop>å°èˆª</a>
               </div>

               <div v-if="evt.imgUrl" class="mt-2 rounded-lg overflow-hidden h-32 w-full relative border border-gray-100">
                  <img :src="evt.imgUrl" class="w-full h-full object-cover" @click.stop="viewImage(evt.imgUrl)">
               </div>

               <p v-if="evt.note" class="mt-2 text-sm text-gray-600 allow-select line-clamp-2">{{ evt.note }}</p>
               
               <a v-if="evt.link" :href="evt.link" target="_blank" class="mt-2 block text-xs text-blue-500 truncate swipe-protected" @click.stop>ğŸ”— ç›¸é—œé€£çµ</a>
            </div>
         </div>
         
         <div v-if="getEvents(selDate).length === 0" class="text-center py-10 text-gray-400 text-sm">
            æœ¬æ—¥å°šç„¡è¡Œç¨‹
         </div>

         <button @click="openAddItin" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold mb-6 swipe-protected">
            + æ–°å¢è¡Œç¨‹
         </button>
      </div>
    </div>

    <div v-if="tab==='expense'">
       <div class="ios-card bg-white shadow-sm ring-1 ring-black/5 swipe-protected">
          <div class="flex justify-between items-center mb-3">
             <h3 class="font-bold text-gray-800">è¨˜ä¸€ç­†</h3>
             <span class="text-xs text-blue-500 font-bold" @click="newExp.currency = newExp.currency === 'NTD' ? 'NOK' : 'NTD'">{{ newExp.currency }}</span>
          </div>
          
          <div class="flex gap-2 mb-3">
             <input type="number" v-model="newExp.amount" placeholder="0" class="flex-1 text-3xl font-bold bg-transparent outline-none placeholder-gray-200">
             <select v-model="newExp.currency" class="bg-gray-100 rounded-lg px-2 text-sm font-bold text-gray-600 outline-none">
                <option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option><option>GBP</option><option>AED</option>
             </select>
          </div>
          <div v-if="newExp.amount && newExp.currency !== 'NTD'" class="text-right text-xs text-gray-400 mb-3 font-mono">
             â‰ˆ {{ formatNumber(Math.round(newExp.amount * rates[newExp.currency])) }} NTD
          </div>

          <div class="grid grid-cols-2 gap-2 mb-3">
             <div class="ios-input-group">
                <select v-model="newExp.item" class="ios-input text-sm">
                   <option value="" disabled selected>é …ç›®</option>
                   <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>é›¶é£Ÿ</option><option>ä½å®¿</option>
                   <option>äº¤é€šï¼ˆæ©Ÿç¥¨ï¼‰</option><option>äº¤é€šï¼ˆç§Ÿè»Šï¼‰</option><option>äº¤é€šï¼ˆåœè»Šè²»ï¼‰</option><option>äº¤é€šï¼ˆæ²¹éŒ¢ï¼‰</option>
                   <option>ç´€å¿µå“</option><option>é–€ç¥¨</option><option>å…¶ä»–</option>
                </select>
             </div>
             <div class="ios-input-group">
                <select v-model="newExp.payer" class="ios-input text-sm">
                   <option value="" disabled selected>èª°ä»˜éŒ¢</option>
                   <option>å®¶é½Š</option><option>äº­ç©</option><option>åª½åª½</option>
                </select>
             </div>
          </div>
          
          <div class="ios-input-group mb-3">
             <input v-model="newExp.note" placeholder="å‚™è¨» (é¸å¡«)" class="ios-input text-sm">
          </div>

          <div class="flex gap-2 mb-4 overflow-x-auto pb-1">
             <button v-for="m in members" :key="m" @click="toggleMember(m)"
                :class="['px-3 py-1.5 rounded-full text-xs font-bold border transition-colors flex-shrink-0',
                   newExp.involved.includes(m) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-400 border-gray-200']">
                {{ m }}
             </button>
             <button @click="toggleSelectAll" class="text-xs text-blue-500 font-bold px-2">å…¨é¸</button>
          </div>

          <button @click="submitExp" class="ios-btn py-3 shadow-lg shadow-blue-500/30">ç¢ºèª</button>
       </div>

       <div class="mt-6 mb-2 flex justify-between items-center px-1">
          <h3 class="text-lg font-bold text-gray-800">æœ€è¿‘æ¶ˆè²»</h3>
          <span class="text-xs text-gray-400">NTD {{ formatNumber(filteredExpenses.reduce((a,b)=>a+getAmountTWD(b),0)) }}</span>
       </div>

       <div class="space-y-3 pb-10">
          <div v-for="exp in filteredExpenses" :key="exp.row" 
               class="bg-white p-4 rounded-xl border-b border-gray-100 flex justify-between items-start active:bg-gray-50 transition-colors"
               @click="openEditExp(exp)">
             <div>
                <div class="flex items-center gap-2 mb-1">
                   <span class="text-sm font-bold text-gray-900">{{ exp.item }}</span>
                   <span v-if="exp.note" class="text-xs text-gray-500 truncate max-w-[120px]">{{ exp.note }}</span>
                </div>
                <div class="flex gap-1.5 flex-wrap">
                   <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">{{ exp.date.slice(5) }}</span>
                   <span class="text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">{{ exp.payer }} ä»˜</span>
                   <span class="text-[10px] bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded">åˆ†: {{ exp.involved.join(',') }}</span>
                </div>
             </div>
             <div class="text-right">
                <div class="font-bold text-gray-900">{{ formatNumber(exp.amount) }} <span class="text-[10px]">{{ exp.currency }}</span></div>
                <div v-if="exp.currency!=='NTD'" class="text-[10px] text-gray-400">â‰ˆ {{ formatNumber(getAmountTWD(exp)) }}</div>
             </div>
          </div>
          <div v-if="filteredExpenses.length===0" class="text-center py-8 text-gray-400 text-sm">æš«ç„¡ç´€éŒ„</div>
       </div>
    </div>

    <div v-if="tab==='analysis'">
       <div class="ios-card bg-gradient-to-br from-[#007AFF] to-[#5856D6] text-white border-0 shadow-lg mb-6 relative overflow-hidden">
          <div class="relative z-10">
             <div class="text-xs opacity-70 font-semibold uppercase tracking-wider mb-1">å®¶é½Š+äº­ç© å‰©é¤˜é ç®—</div>
             <div class="text-4xl font-bold tracking-tight mb-4">{{ formatNumber(Math.round(500000 - publicSpent)) }}</div>
             
             <div class="w-full bg-black/20 h-1.5 rounded-full overflow-hidden mb-2">
                <div class="bg-white h-full" :style="{width: Math.min((publicSpent/500000)*100, 100) + '%'}"></div>
             </div>
             <div class="flex justify-between text-[10px] font-medium opacity-80">
                <span>å·²ç”¨: {{ formatNumber(Math.round(publicSpent)) }}</span>
                <span>ç¸½é¡: 500,000</span>
             </div>
          </div>
          <div class="absolute -right-6 -top-6 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
       </div>

       <div class="flex gap-2 mb-4 swipe-protected overflow-x-auto px-1 scrollbar-hide">
          <button @click="showFilterMenu=!showFilterMenu" class="bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">
             {{ showFilterMenu ? 'æ”¶èµ·ç¯©é¸' : 'ç¯©é¸ç´€éŒ„' }}
          </button>
          <button @click="openRateModal" class="bg-white border border-gray-200 text-gray-600 px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap">
             åŒ¯ç‡è¨­å®š
          </button>
       </div>

       <div v-if="showFilterMenu" class="ios-card bg-gray-50 mb-4 transition-all swipe-protected">
          <div class="grid grid-cols-2 gap-2">
             <select v-model="filters.item" class="ios-input text-xs bg-white rounded p-2 h-auto"><option value="ALL">å…¨éƒ¨é …ç›®</option><option v-for="i in uniqueItems" :key="i">{{i}}</option></select>
             <select v-model="filters.payer" class="ios-input text-xs bg-white rounded p-2 h-auto"><option value="ALL">å…¨éƒ¨ä»˜æ¬¾äºº</option><option v-for="p in members" :key="p">{{p}}</option></select>
             <select v-model="filters.payment" class="ios-input text-xs bg-white rounded p-2 h-auto col-span-2"><option value="ALL">å…¨éƒ¨æ–¹å¼</option><option v-for="p in uniquePayments" :key="p">{{p}}</option></select>
          </div>
          <button @click="resetFilters" class="w-full text-xs text-blue-500 font-bold mt-2 py-2">é‡ç½®æ¢ä»¶</button>
       </div>

       <div class="ios-card h-64 flex flex-col items-center justify-center relative">
          <h3 class="absolute top-4 left-4 font-bold text-gray-800 text-sm">æ¶ˆè²»åˆ†ä½ˆ</h3>
          <div v-if="chartBusy" class="text-xs text-gray-400">è¼‰å…¥ä¸­...</div>
          <canvas id="expenseChart"></canvas>
       </div>

       <div class="ios-list-group">
          <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">åˆ†å¸³çµç®—</div>
          <div v-for="d in debts" :key="d.from+d.to" class="ios-list-item">
             <div class="flex items-center gap-2">
                <span class="font-bold text-gray-800">{{d.from}}</span>
                <span class="text-[10px] text-gray-400">çµ¦</span>
                <span class="font-bold text-gray-800">{{d.to}}</span>
             </div>
             <span class="font-bold text-blue-600">NT$ {{formatNumber(d.amount)}}</span>
          </div>
          <div v-if="debts.length===0" class="p-4 text-center text-xs text-gray-400">ç›®å‰ç„¡æ¬ æ¬¾</div>
       </div>
       
       <div class="ios-list-group">
           <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">åª½åª½æ¶ˆè²»çµ±è¨ˆ</div>
           <div class="ios-list-item">
               <span class="text-sm">ç¸½è¨ˆæ”¯å‡º</span>
               <span class="font-bold">NT$ {{ formatNumber(Math.round(momSpent)) }}</span>
           </div>
       </div>
    </div>

  </div> <nav class="bottom-tab-bar swipe-protected">
    <div class="tab-item" :class="{ active: tab === 'itinerary' }" @click="tab = 'itinerary'">
      <svg class="tab-icon" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5z"></path></svg>
      <span>è¡Œç¨‹</span>
    </div>
    <div class="tab-item" :class="{ active: tab === 'expense' }" @click="tab = 'expense'">
      <svg class="tab-icon" viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"></path></svg>
      <span>è¨˜å¸³</span>
    </div>
    <div class="tab-item" :class="{ active: tab === 'analysis' }" @click="changeTabToAnalysis">
      <svg class="tab-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path></svg>
      <span>åˆ†æ</span>
    </div>
  </nav>

  <div :class="['modal-overlay swipe-protected', showItinModal ? 'active' : '']" @click.self="showItinModal=false">
     <div class="bottom-sheet">
        <div class="flex justify-between items-center mb-6">
           <h3 class="text-xl font-bold">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
           <button @click="showItinModal=false" class="bg-gray-200 rounded-full p-1 text-gray-500 w-8 h-8 font-bold">âœ•</button>
        </div>
        
        <div class="space-y-4">
           <div class="flex gap-4">
              <div class="flex-1">
                 <label class="text-xs font-bold text-gray-500 uppercase block mb-1">æ™‚é–“</label>
                 <div class="ios-input-group">
                    <input type="time" v-model="itinForm.startTime" class="ios-input">
                 </div>
              </div>
              <div class="flex-1">
                 <label class="text-xs font-bold text-gray-500 uppercase block mb-1">çµæŸ (é¸)</label>
                 <div class="ios-input-group">
                    <input type="time" v-model="itinForm.endTime" class="ios-input">
                 </div>
              </div>
           </div>

           <div>
              <label class="text-xs font-bold text-gray-500 uppercase block mb-1">æ¨™é¡Œ</label>
              <div class="ios-input-group">
                 <input v-model="itinForm.title" placeholder="è¡Œç¨‹åç¨±" class="ios-input">
              </div>
           </div>

           <div>
              <label class="text-xs font-bold text-gray-500 uppercase block mb-1">é¡åˆ¥</label>
              <div class="flex gap-2 flex-wrap">
                 <button v-for="c in ['æ™¯é»','é£²é£Ÿ','äº¤é€š','ä½å®¿','å…¶ä»–']" :key="c" @click="itinForm.category=c"
                    :class="['px-4 py-2 rounded-lg text-sm font-bold border transition-colors',
                       itinForm.category===c ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-200']">
                    {{c}}
                 </button>
              </div>
           </div>

           <div>
              <label class="text-xs font-bold text-gray-500 uppercase block mb-1">åœ–ç‰‡</label>
              <div class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center relative">
                 <div v-if="!itinForm.imgUrl && !itinForm.newImageBase64" class="text-gray-400 text-sm font-bold">é»æ“Šä¸Šå‚³ç…§ç‰‡</div>
                 <img v-else :src="itinForm.newImageBase64 || itinForm.imgUrl" class="h-32 w-full object-cover rounded-lg mx-auto">
                 <input type="file" accept="image/*" @change="handleImageUpload" class="absolute inset-0 opacity-0 w-full h-full">
                 <button v-if="itinForm.imgUrl || itinForm.newImageBase64" @click.stop.prevent="removeImage" 
                         class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full z-10">ç§»é™¤</button>
              </div>
           </div>

           <div class="ios-input-group">
              <input v-model="itinForm.location" placeholder="åœ°é» (Google Maps)" class="ios-input text-sm">
           </div>
           
           <div class="ios-input-group">
              <input v-model="itinForm.link" placeholder="ç›¸é—œé€£çµ URL" class="ios-input text-sm text-blue-600">
           </div>

           <div class="ios-input-group h-auto py-2">
              <textarea v-model="itinForm.note" rows="3" placeholder="å‚™è¨»..." class="ios-input resize-none text-sm"></textarea>
           </div>

           <button @click="submitItin" class="ios-btn text-lg">å„²å­˜</button>
           <button v-if="isEditing" @click="deleteItin(itinForm);showItinModal=false" class="ios-btn ios-btn-danger mt-2">åˆªé™¤æ­¤è¡Œç¨‹</button>
        </div>
     </div>
  </div>

  <div :class="['modal-overlay swipe-protected', showExpModal ? 'active' : '']" @click.self="showExpModal=false">
     <div class="bottom-sheet">
        <div class="flex justify-between items-center mb-6">
           <h3 class="text-xl font-bold">ç·¨è¼¯æ¶ˆè²»</h3>
           <button @click="showExpModal=false" class="bg-gray-200 rounded-full p-1 text-gray-500 w-8 h-8 font-bold">âœ•</button>
        </div>
        
        <div class="space-y-4">
           <div class="flex gap-2">
              <div class="ios-input-group w-1/3">
                 <select v-model="editExpForm.currency" class="ios-input font-bold text-blue-600"><option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option></select>
              </div>
              <div class="ios-input-group flex-1">
                 <input type="number" v-model="editExpForm.amount" class="ios-input text-xl font-bold">
              </div>
           </div>
           
           <div class="ios-input-group">
              <input v-model="editExpForm.item" class="ios-input" placeholder="é …ç›®">
           </div>
           
           <div class="flex gap-2">
             <div class="ios-input-group flex-1">
                <select v-model="editExpForm.payer" class="ios-input"><option v-for="m in members" :key="m">{{m}}</option></select>
             </div>
             <div class="ios-input-group flex-1">
                <select v-model="editExpForm.payment" class="ios-input"><option>ç¾é‡‘</option><option>ä¿¡ç”¨å¡-åœ‹æ³°</option><option>ä¿¡ç”¨å¡-æ°¸è±</option><option>ä¿¡ç”¨å¡-å…ƒå¤§</option></select>
             </div>
           </div>
           
           <div class="p-3 bg-gray-50 rounded-xl">
              <div class="flex justify-between mb-2">
                 <span class="text-xs font-bold text-gray-500 uppercase">åˆ†æ”¤çµ¦</span>
                 <button @click="toggleSelectAllEdit" class="text-xs text-blue-500 font-bold">å…¨é¸</button>
              </div>
              <div class="flex gap-2 flex-wrap">
                 <label v-for="m in members" :key="m" 
                        :class="['px-3 py-2 rounded-lg border text-sm font-bold flex-1 text-center', 
                        (editExpForm.involved||[]).includes(m) ? 'bg-white border-blue-500 text-blue-600 shadow-sm' : 'border-transparent text-gray-400']">
                    <input type="checkbox" :value="m" v-model="editExpForm.involved" class="hidden">{{m}}
                 </label>
              </div>
           </div>

           <div class="flex gap-3 mt-4">
              <button @click="deleteExp(editExpForm);showExpModal=false" class="ios-btn ios-btn-danger flex-1">åˆªé™¤</button>
              <button @click="submitEditExp" class="ios-btn flex-[2]">æ›´æ–°</button>
           </div>
        </div>
     </div>
  </div>
  
  <div :class="['modal-overlay swipe-protected', showRateModal ? 'active' : '']" @click.self="showRateModal=false">
      <div class="bottom-sheet">
          <h3 class="text-xl font-bold mb-4">è¨­å®šåŒ¯ç‡ (å°å°å¹£)</h3>
          <div class="space-y-3">
              <div v-for="c in ['NOK','ISK','EUR','GBP','AED']" :key="c" class="flex justify-between items-center border-b pb-2">
                  <span class="font-bold text-gray-500 w-12">{{c}}</span>
                  <input type="number" v-model="tempRates[c]" class="text-right font-mono font-bold text-lg bg-transparent outline-none w-32" placeholder="0.0">
              </div>
          </div>
          <button @click="saveRates" class="ios-btn mt-6">å„²å­˜è¨­å®š</button>
      </div>
  </div>

  <Transition name="fade">
    <div v-if="showImgViewer" 
         class="img-viewer-overlay" 
         @click="closeImgViewer"
         @touchstart="handleImgTouchStart"
         @touchmove="handleImgTouchMove"
         @touchend="handleImgTouchEnd"
         @dblclick="toggleZoom">
        
        <div class="img-viewer-close" @click.stop="closeImgViewer">âœ•</div>
        
        <img :src="viewingImg" 
             ref="imgViewerEl"
             class="img-viewer-img" 
             style="transform: scale(1) translate(0px, 0px);"
             @click.stop>
             
        <div class="absolute bottom-10 text-white/50 text-sm font-bold" v-if="imgGesture.scale===1">â†“ ä¸‹æ‹‰é—œé–‰</div>
    </div>
  </Transition>

</div>

<script>
/* ä¿ç•™åŸå§‹é‚è¼¯ï¼Œåƒ…é©é…æ–°çš„ DOM çµæ§‹èˆ‡è®Šæ•¸ 
   æ ¸å¿ƒï¼šVue 3 + Tailwind (CSSè®Šæ•¸è¦†å¯«) + GAS Backend
*/

const YOUR_GAS_URL = 'https://script.google.com/macros/s/AKfycbz6PZtqLJzlS2a71R-RfZjpJCuqJVPoP7RuNxEe74mS_uvxBejMNGKboFSn2ArNnXAu/exec';
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}

async function callApi(action, data = null, method = 'GET') {
  const options = { method };
  if (method === 'POST') {
    options.body = JSON.stringify({ action, data });
    options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
  }
  let url = YOUR_GAS_URL;
  if (method === 'GET') url += `?action=${action}`;
  try {
    const response = await fetch(url, options);
    if (!response.ok) throw new Error("Network error");
    return await response.json();
  } catch(e) { console.warn("API Fail:", e); return null; }
}

const { createApp, ref, computed, onMounted, nextTick, watch, onBeforeUnmount } = Vue;

createApp({
  setup() {
    const tab = ref('itinerary');
    const isLoading = ref(true);
    const isFirstLoad = ref(true);
    const isPullRefreshing = ref(false);
    const isOnline = ref(navigator.onLine);
    const isSyncing = ref(false);
    const syncQueue = ref([]);
    
    const members = ref([]);
    const expenses = ref([]);
    const itinerary = ref([]);
    const rates = ref({});

    const dateContainer = ref(null);
    const scrollContainer = ref(null);
    const todayDate = ref('');
    const todayWeekday = ref('');

    // Img Viewer
    const showImgViewer = ref(false);
    const viewingImg = ref('');
    const imgViewerEl = ref(null);
    const imgGesture = ref({ startX: 0, startY: 0, currentX: 0, currentY: 0, scale: 1, isPulling: false, isZooming: false, startDistance: 0 });

    /* Gesture Logic for Image */
    const getDistance = (touches) => Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
    const handleImgTouchStart = (e) => {
        if (e.touches.length === 2) { imgGesture.value.isZooming = true; imgGesture.value.startDistance = getDistance(e.touches); }
        else if (e.touches.length === 1) { imgGesture.value.startX = e.touches[0].clientX; imgGesture.value.startY = e.touches[0].clientY; imgGesture.value.isPulling = false; }
    };
    const handleImgTouchMove = (e) => {
        if(!showImgViewer.value) return;
        e.preventDefault();
        if (e.touches.length === 2 && imgGesture.value.isZooming) {
            const dist = getDistance(e.touches);
            let newScale = Math.max(1, Math.min(imgGesture.value.scale * (dist / imgGesture.value.startDistance), 4));
            if (imgViewerEl.value) imgViewerEl.value.style.transform = `scale(${newScale})`;
            imgGesture.value.tempScale = newScale;
        } else if (e.touches.length === 1 && imgGesture.value.scale === 1) {
            const dy = e.touches[0].clientY - imgGesture.value.startY;
            if (dy > 0) {
                imgGesture.value.isPulling = true;
                if (imgViewerEl.value) imgViewerEl.value.style.transform = `translateY(${dy}px) scale(${1 - dy/1000})`;
                const overlay = document.querySelector('.img-viewer-overlay');
                if(overlay) overlay.style.backgroundColor = `rgba(0,0,0,${Math.max(0, 1 - dy/600)})`;
            }
        }
    };
    const handleImgTouchEnd = () => {
        if (imgGesture.value.isZooming) {
            if (imgGesture.value.tempScale) imgGesture.value.scale = imgGesture.value.tempScale;
            imgGesture.value.isZooming = false;
            if (imgGesture.value.scale < 1) { imgGesture.value.scale = 1; if(imgViewerEl.value) imgViewerEl.value.style.transform = `scale(1)`; }
        } else if (imgGesture.value.isPulling) {
            const dy = event.changedTouches[0].clientY - imgGesture.value.startY;
            if (dy > 100) closeImgViewer();
            else { if(imgViewerEl.value) imgViewerEl.value.style.transform = `scale(${imgGesture.value.scale})`; }
            imgGesture.value.isPulling = false;
        }
    };
    const toggleZoom = () => {
        imgGesture.value.scale = imgGesture.value.scale > 1 ? 1 : 2.5;
        if(imgViewerEl.value) imgViewerEl.value.style.transform = `scale(${imgGesture.value.scale})`;
    };

    /* Core Logic */
    const tripStatus = computed(() => {
      const now = new Date(); const start = new Date('2026-08-30'); const end = new Date('2026-09-26');
      now.setHours(0,0,0,0); start.setHours(0,0,0,0); end.setHours(0,0,0,0);
      if (now < start) return `å€’æ•¸ ${Math.ceil((start - now)/86400000)} å¤©`;
      if (now >= start && now <= end) return `DAY ${Math.floor((now - start)/86400000) + 1}`;
      return '';
    });

    const tripDates = []; const startDate = new Date('2026-08-30');
    for (let d = new Date(startDate); d <= new Date('2026-09-26'); d.setDate(d.getDate()+1)) {
      tripDates.push({ date: d.toISOString().split('T')[0], short: (d.getMonth()+1)+'/'+d.getDate() });
    }
    const selDate = ref(tripDates[0].date);
    
    // Filters & Modals
    const showFilterMenu = ref(false);
    const filters = ref({ date: 'ALL', item: 'ALL', payer: 'ALL', location: 'ALL', payment: 'ALL' });
    const showRateModal = ref(false);
    const showItinModal = ref(false);
    const showExpModal = ref(false);
    const isEditing = ref(false);
    
    // Forms
    const itinForm = ref({ row: null, startTime: '09:00', endTime: '', category: 'æ™¯é»', title: '', location: '', link: '', note: '', imgUrl: '', newImageBase64: null });
    const newExp = ref({ payer: '', location: '', item: '', payment: '', currency: 'NTD', amount: null, involved: [], note: '' });
    const editExpForm = ref({});
    const tempRates = ref({});

    // Helpers
    const toggleMember = (m) => {
        if(newExp.value.involved.includes(m)) newExp.value.involved = newExp.value.involved.filter(x=>x!==m);
        else newExp.value.involved.push(m);
    };
    const toggleSelectAll = () => { newExp.value.involved = newExp.value.involved.length === members.value.length ? [] : [...members.value]; };
    const toggleSelectAllEdit = () => { 
        if(!editExpForm.value.involved) editExpForm.value.involved = [];
        editExpForm.value.involved = editExpForm.value.involved.length === members.value.length ? [] : [...members.value];
    };

    const pullDistance = ref(0);
    const refreshText = computed(() => isPullRefreshing.value ? 'æ›´æ–°ä¸­...' : 'ä¸‹æ‹‰æ›´æ–°');

    const initDate = () => {
      const now = new Date();
      todayDate.value = now.getFullYear() + '.' + String(now.getMonth()+1).padStart(2,'0') + '.' + String(now.getDate()).padStart(2,'0');
      todayWeekday.value = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][now.getDay()];
    };

    // Scroll Logic for Pull Refresh
    const attachGestureListeners = () => {
      const el = scrollContainer.value;
      if (!el) return;
      let startY = 0;
      el.addEventListener('touchstart', (e) => { if(el.scrollTop <= 0) startY = e.touches[0].clientY; }, {passive: true});
      el.addEventListener('touchmove', (e) => {
         const y = e.touches[0].clientY;
         if (el.scrollTop <= 0 && y > startY) {
            const diff = y - startY;
            if(diff < 200) pullDistance.value = diff * 0.4;
         }
      }, {passive: false});
      el.addEventListener('touchend', () => {
         if (pullDistance.value > 60) { isPullRefreshing.value = true; loadData(); }
         pullDistance.value = 0;
      }, {passive: true});
    };

    const saveLocal = () => {
      try { localStorage.setItem('tripData_v36', JSON.stringify({ expenses: expenses.value, itinerary: itinerary.value, members: members.value, rates: rates.value }));
            localStorage.setItem('syncQueue_v36', JSON.stringify(syncQueue.value)); } catch(e){}
    };
    const loadLocal = () => {
      const d = localStorage.getItem('tripData_v36'); const q = localStorage.getItem('syncQueue_v36');
      if (q) syncQueue.value = JSON.parse(q);
      if (d) { const p = JSON.parse(d); expenses.value=p.expenses||[]; itinerary.value=p.itinerary||[]; members.value=p.members||[]; rates.value=p.rates||{}; return true; }
      return false;
    };

    const updateLocalData = (res) => {
      if (res && res.expenses) { expenses.value = res.expenses; itinerary.value = res.itinerary; members.value = res.members; rates.value = res.rates; saveLocal(); if (tab.value === 'analysis') scheduleRenderChart(); }
    };

    const processSyncQueue = async () => {
      if (syncQueue.value.length === 0 || !navigator.onLine || isSyncing.value) return;
      isSyncing.value = true;
      const queue = [...syncQueue.value]; const remaining = [];
      for (const job of queue) {
        try {
          const apiAction = (job.action==='delete'?'deleteRow':job.action+(job.type==='itin'?'Itinerary':'Expense'));
          const res = await callApi(apiAction, job.data, 'POST');
          if (res) updateLocalData(res); else remaining.push(job);
        } catch (e) { remaining.push(job); }
      }
      syncQueue.value = remaining; saveLocal(); isSyncing.value = false;
      if (syncQueue.value.length === 0) loadData();
    };

    const handleCRUD = async (type, action, data) => {
       if (navigator.onLine) {
         isSyncing.value = true;
         try { const apiAction = (action==='delete'?'deleteRow':action+(type==='itin'?'Itinerary':'Expense'));
               const res = await callApi(apiAction, data, 'POST'); if(!res) throw new Error(); updateLocalData(res);
         } catch(e) { syncQueue.value.push({type,action,data}); } finally { isSyncing.value = false; }
       } else syncQueue.value.push({type,action,data});
       saveLocal();
    };

    const loadData = async () => {
      if (!isPullRefreshing.value) isLoading.value = true;
      if (loadLocal()) { if (isFirstLoad.value) { nextTick(()=>checkAndScrollToToday()); isFirstLoad.value=false; } if(tab.value==='analysis') scheduleRenderChart(); setTimeout(()=>{if(!isPullRefreshing.value)isLoading.value=false},150); }
      if (!navigator.onLine) { isLoading.value=false; isPullRefreshing.value=false; return; }
      try { const res = await callApi('getData'); updateLocalData(res); } catch(e){} finally { isLoading.value=false; isPullRefreshing.value=false; }
    };

    const selectDate = (date) => { selDate.value = date; scrollToDateBtn(date); if(scrollContainer.value) scrollContainer.value.scrollTop = 0; };
    const scrollToDateBtn = (date) => {
      nextTick(() => { const btn = document.getElementById('date-btn-'+date); if(btn && dateContainer.value) dateContainer.value.scrollTo({ left: btn.offsetLeft - dateContainer.value.clientWidth/2 + btn.clientWidth/2, behavior: 'smooth' }); });
    };
    const checkAndScrollToToday = () => {
      const offset = new Date().getTimezoneOffset()*60000; const todayStr = new Date(Date.now()-offset).toISOString().split('T')[0];
      if (tripDates.some(x=>x.date===todayStr)) selectDate(todayStr); else selectDate(tripDates[0].date);
    };

    const getDayInfo = (dStr) => { const d=new Date(dStr); const diff=Math.ceil((d-startDate)/86400000)+1; return `DAY ${diff} Â· ${['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'][d.getDay()]}`; };
    const getEvents = (d) => itinerary.value.filter(e => e.date === d).sort((a,b)=>a.startTime.localeCompare(b.startTime));
    const formatNumber = (n) => String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

    // Dynamic Options
    const uniqueItems = computed(() => [...new Set(expenses.value.map(e => e.item))].filter(Boolean));
    const uniquePayments = computed(() => [...new Set(expenses.value.map(e => e.payment))].filter(Boolean));
    const resetFilters = () => { filters.value = { date:'ALL', item:'ALL', payer:'ALL', location:'ALL', payment:'ALL' }; };
    
    const filteredExpenses = computed(() => expenses.value.filter(e => {
        if (filters.value.item !== 'ALL' && e.item !== filters.value.item) return false;
        if (filters.value.payer !== 'ALL' && e.payer !== filters.value.payer) return false;
        if (filters.value.payment !== 'ALL' && e.payment !== filters.value.payment) return false;
        return true;
    }));

    const getAmountTWD = (exp) => (exp.amountTWD && exp.amountTWD > 0) ? exp.amountTWD : Math.round(exp.amount * (rates.value[exp.currency] || 1));
    const publicSpent = computed(() => expenses.value.reduce((s,e) => { const amt = getAmountTWD(e); if(!e.involved||!e.involved.length) return s; const per = amt/e.involved.length; return s + (e.involved.includes('å®¶é½Š')?per:0) + (e.involved.includes('äº­ç©')?per:0); }, 0));
    const momSpent = computed(() => expenses.value.reduce((s,e) => e.involved?.includes('åª½åª½') ? s+(getAmountTWD(e)/e.involved.length) : s, 0));
    
    const debts = computed(() => {
      if (!members.value.length) return [];
      const bal = {}; members.value.forEach(m=>bal[m]=0);
      expenses.value.forEach(e => {
        const amt = getAmountTWD(e); const split = e.involved||[];
        if (split.length) { bal[e.payer] += amt; const share = amt/split.length; split.forEach(p=>bal[p]-=share); }
      });
      let debtors=[], creditors=[];
      for (const m in bal) { if (bal[m]<-1) debtors.push({p:m, a:bal[m]}); if(bal[m]>1) creditors.push({p:m, a:bal[m]}); }
      debtors.sort((a,b)=>a.a-b.a); creditors.sort((a,b)=>b.a-a.a);
      const res=[]; let i=0, j=0;
      while(i<debtors.length && j<creditors.length){
        const amt=Math.min(Math.abs(debtors[i].a), creditors[j].a);
        res.push({from:debtors[i].p, to:creditors[j].p, amount:Math.round(amt)});
        debtors[i].a += amt; creditors[j].a -= amt;
        if (Math.abs(debtors[i].a)<1) i++; if (creditors[j].a<1) j++;
      }
      return res;
    });

    // Chart
    let chartInstance = null; const chartBusy = ref(false); let chartTimer = null;
    const renderChart = () => {
      const cvs = document.getElementById('expenseChart'); if(!cvs) return;
      const stats = {}; filteredExpenses.value.forEach(e => { const k=e.item||'å…¶ä»–'; stats[k]=(stats[k]||0)+getAmountTWD(e); });
      const labels = Object.keys(stats); const data = Object.values(stats);
      const colors = ['#007AFF', '#5856D6', '#FF9500', '#FF2D55', '#AF52DE', '#5AC8FA', '#34C759', '#FFCC00'];
      
      if (chartInstance) { chartInstance.data.labels=labels; chartInstance.data.datasets[0].data=data; chartInstance.data.datasets[0].backgroundColor=labels.map((_,i)=>colors[i%colors.length]); chartInstance.update(); }
      else chartInstance = new Chart(cvs, {
          type: 'doughnut',
          data: { labels, datasets: [{ data, backgroundColor: labels.map((_,i)=>colors[i%colors.length]), borderWidth: 0 }] },
          options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } }
      });
      chartBusy.value = false;
    };
    const scheduleRenderChart = () => { chartBusy.value=true; clearTimeout(chartTimer); chartTimer=setTimeout(()=>nextTick(renderChart), 300); };
    const changeTabToAnalysis = () => { tab.value='analysis'; if(chartInstance) { chartInstance.destroy(); chartInstance=null; } scheduleRenderChart(); };

    // Watchers
    watch(tab, (v) => { if(v==='analysis') scheduleRenderChart(); if(v==='expense') newExp.value = { payer:'', location:'', item:'', payment:'', currency:'NTD', amount:null, involved:[], note:'' }; });
    watch(filters, ()=>tab.value==='analysis'&&scheduleRenderChart(), {deep:true});
    watch(expenses, ()=>tab.value==='analysis'&&scheduleRenderChart(), {deep:true});

    // Actions
    const openRateModal = () => { tempRates.value={...rates.value}; showRateModal.value=true; };
    const openAddItin = () => { itinForm.value={ row:null, startTime:'09:00', endTime:'', category:'æ™¯é»', title:'', location:'', link:'', note:'', imgUrl:'', newImageBase64:null }; isEditing.value=false; showItinModal.value=true; };
    const openEditItin = (evt) => { itinForm.value={...evt, newImageBase64:null}; isEditing.value=true; showItinModal.value=true; };
    const openEditExp = (exp) => { editExpForm.value=JSON.parse(JSON.stringify(exp)); showExpModal.value=true; };
    const handleImageUpload = (e) => { const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ itinForm.value.imgUrl=ev.target.result; itinForm.value.newImageBase64=ev.target.result; }; r.readAsDataURL(f); };
    const removeImage = () => { itinForm.value.imgUrl=''; itinForm.value.newImageBase64=null; };
    const viewImage = (url) => { viewingImg.value=url; showImgViewer.value=true; imgGesture.value.scale=1; };
    const closeImgViewer = () => { showImgViewer.value=false; };

    const deleteItin = (evt) => { 
        if(!confirm('ç¢ºå®šåˆªé™¤?')) return; itinerary.value=itinerary.value.filter(x=>x.row!==evt.row);
        handleCRUD('itin', 'delete', {row:evt.row, sheetName:'Itinerary'});
    };
    const deleteExp = (exp) => { 
        if(!confirm('ç¢ºå®šåˆªé™¤?')) return; expenses.value=expenses.value.filter(x=>x.row!==exp.row);
        handleCRUD('exp', 'delete', {row:exp.row, sheetName:'Expenses'});
    };
    const submitItin = () => {
        if(!itinForm.value.title) return alert('è«‹è¼¸å…¥æ¨™é¡Œ');
        const newRow = isEditing.value ? itinForm.value.row : Date.now();
        const payload = { ...itinForm.value, row: newRow, date: selDate.value };
        if(isEditing.value) { const idx=itinerary.value.findIndex(x=>x.row===newRow); if(idx!==-1) itinerary.value[idx]=payload; handleCRUD('itin', 'edit', payload); }
        else { itinerary.value.push(payload); handleCRUD('itin', 'add', payload); }
        showItinModal.value=false;
    };
    const submitExp = () => {
        if(!newExp.value.amount || !newExp.value.item) return alert('è«‹è¼¸å…¥é‡‘é¡èˆ‡é …ç›®');
        const payload = { ...newExp.value, row: Date.now(), date: new Date().toISOString().split('T')[0], time: new Date().toTimeString().slice(0,5), amountTWD: Math.round(newExp.value.amount * (rates.value[newExp.value.currency]||1)) };
        expenses.value.unshift(payload); handleCRUD('exp', 'add', payload);
        newExp.value.amount=null; newExp.value.item=''; newExp.value.note=''; newExp.value.involved=[];
    };
    const submitEditExp = () => {
        const idx = expenses.value.findIndex(e=>e.row===editExpForm.value.row); if(idx===-1) return;
        const updated = { ...editExpForm.value, amountTWD: Math.round(editExpForm.value.amount * (rates.value[editExpForm.value.currency]||1)) };
        expenses.value[idx]=updated; showExpModal.value=false; handleCRUD('exp', 'edit', updated);
    };
    const saveRates = () => { rates.value={...tempRates.value}; saveLocal(); showRateModal.value=false; callApi('updateRates', rates.value, 'POST'); };
    const confirmClearSync = () => { if(confirm('æ¸…é™¤å¾…ä¸Šå‚³è³‡æ–™?')) { syncQueue.value=[]; saveLocal(); } };
    const isItemPending = (row) => syncQueue.value.some(j=>j.data.row===row);

    onMounted(async () => {
      initDate(); window.addEventListener('online', ()=>isOnline.value=true); window.addEventListener('offline', ()=>isOnline.value=false);
      await nextTick(); attachGestureListeners(); loadData(); if(navigator.onLine) processSyncQueue();
    });
    onBeforeUnmount(() => { if (chartInstance) chartInstance.destroy(); });

    return {
      tab, isLoading, isOnline, isSyncing, syncQueue, confirmClearSync, isItemPending,
      dateContainer, scrollContainer, pullDistance, refreshText,
      todayDate, todayWeekday, tripStatus, tripDates, selDate, selectDate, getDayInfo, getEvents,
      itinerary, expenses, rates, members,
      showFilterMenu, filters, uniqueItems, uniquePayments, resetFilters, filteredExpenses,
      formatNumber, getAmountTWD, publicSpent, momSpent, debts,
      showItinModal, showExpModal, showRateModal, isEditing,
      itinForm, newExp, editExpForm, tempRates,
      openAddItin, openEditItin, openEditExp, openRateModal,
      submitItin, deleteItin, submitExp, submitEditExp, deleteExp, saveRates,
      handleImageUpload, removeImage, viewImage, closeImgViewer, showImgViewer, viewingImg, imgViewerEl,
      handleImgTouchStart, handleImgTouchMove, handleImgTouchEnd, imgGesture, toggleZoom, toggleMember, toggleSelectAll, toggleSelectAllEdit,
      changeTabToAnalysis, chartBusy
    };
  }
}).mount('#app');
</script>
</body>
</html>

```
