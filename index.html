<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>2026æŒªå¨å†°å³¶ä¹‹æ—…</title>
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="2026 Trip">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f0f9ff">
  
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/snowflake.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --app-bg: #f5f9ff;
      --primary: #0ea5e9;
    }

    /* iOS Reset & Scroll Behavior */
    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden; /* é˜²æ­¢æ©¡çš®ç­‹æ•ˆæœå‡ºç¾åœ¨ body */
      font-family: 'Inter', 'Noto Sans TC', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--app-bg);
      color: #0f172a;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      background: linear-gradient(180deg, #e0f2fe 0%, #f0f9ff 20%, #ffffff 100%);
    }

    /* å…§å®¹æ»¾å‹•å€ */
    .scroll-view {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      padding-top: calc(var(--safe-top) + 60px); /* Header height space */
      padding-bottom: calc(80px + var(--safe-bottom)); /* Tabbar height space */
    }

    /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Glass Effect Components */
    .glass-header {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .glass-tabbar {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
    }

    .glass-input {
      background: rgba(239, 246, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.2s;
    }
    .glass-input:focus {
      background: #fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
    }

    /* Timeline Styles */
    .timeline-line {
      position: absolute;
      left: 24px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e2e8f0;
      z-index: 0;
    }

    /* Animations */
    .ios-press { transition: transform 0.1s; cursor: pointer; }
    .ios-press:active { transform: scale(0.96); opacity: 0.8; }
    
    .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }

    .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }

    /* Pull Indicator */
    .pull-indicator {
      position: absolute;
      top: calc(var(--safe-top) + 50px);
      left: 0; right: 0;
      display: flex; justify-content: center;
      pointer-events: none;
      z-index: 50;
    }
    .spinner {
      width: 24px; height: 24px;
      border: 3px solid rgba(14, 165, 233, 0.3);
      border-top-color: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
    }
    .pulling .spinner { opacity: 1; }
    .refreshing .spinner { opacity: 1; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Utils */
    .text-shadow { text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .safe-pb { padding-bottom: var(--safe-bottom); }
    .safe-pt { padding-top: var(--safe-top); }

    /* Allow Select Class */
    .allow-select { user-select: text; -webkit-user-select: text; }
    
    /* Tags & Badges */
    .tag { @apply px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase border; }
    
    /* Bottom Sheet Modal */
    .bottom-sheet-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 100;
      backdrop-filter: blur(2px);
    }
    .bottom-sheet {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: #fff;
      border-radius: 24px 24px 0 0;
      padding-bottom: calc(20px + var(--safe-bottom));
      z-index: 101;
      box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
      max-height: 90vh;
      display: flex; flex-direction: column;
    }
    
    /* Image Viewer */
    .img-viewer {
      position: fixed; inset: 0; z-index: 999; background: #000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
  </style>
</head>
<body>

<div id="app">
  
  <header class="fixed top-0 left-0 right-0 z-40 glass-header transition-all duration-300 safe-pt">
    <div class="px-5 h-[50px] flex items-center justify-between">
      <div class="flex flex-col">
        <span class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">{{ todayWeekday }}</span>
        <span class="text-lg font-black text-slate-800 leading-none font-mono">{{ todayDate }}</span>
      </div>

      <div class="absolute left-1/2 transform -translate-x-1/2 opacity-0 transition-opacity duration-200" :class="{'opacity-100': scrollY > 40}">
        <span class="font-bold text-sm text-slate-800">2026 æŒªå¨å†°å³¶</span>
      </div>

      <div class="flex items-center gap-2">
         <span v-if="!isOnline" class="w-2 h-2 rounded-full bg-slate-400"></span>
         <span v-if="tripStatus" class="text-[10px] font-bold bg-sky-100 text-sky-600 px-2 py-1 rounded-full">{{ tripStatus }}</span>
         
         <button v-if="isSyncing" class="text-emerald-500 animate-pulse">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
         </button>
         <button v-else-if="syncQueue.length > 0" @click="confirmClearSync" class="text-amber-500 relative ios-press">
            <span class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
         </button>
      </div>
    </div>
  </header>

  <div class="pull-indicator" :class="{ 'pulling': pullDistance > 0, 'refreshing': isPullRefreshing }">
    <div class="spinner" :style="{ transform: `rotate(${pullDistance * 3}deg)` }"></div>
  </div>

  <div class="scroll-view" ref="scrollContainer" @scroll="handleScroll">
    
    <div class="px-5 pb-4 pt-2">
      <h1 class="text-3xl font-black text-slate-800 tracking-tight text-shadow">
        {{ tab === 'itinerary' ? 'Trip Itinerary' : (tab === 'expense' ? 'Expenses' : 'Analysis') }}
      </h1>
      <p class="text-slate-500 text-xs font-bold mt-1 tracking-wide opacity-80">AUG 30 - SEP 26, 2026</p>
    </div>

    <Transition name="fade" mode="out-in">
      
      <div v-if="tab==='itinerary'" key="itinerary" class="pb-10">
        
        <div class="sticky top-[50px] z-30 bg-white/80 backdrop-blur-md border-b border-slate-100 py-3 mb-4 swipe-protected">
          <div ref="dateContainer" class="flex overflow-x-auto px-4 gap-2 no-scrollbar snap-x">
            <button v-for="d in tripDates" :key="d.date" :id="'date-btn-' + d.date" @click="selectDate(d.date)"
              class="flex-shrink-0 flex flex-col items-center justify-center w-[52px] h-[56px] rounded-xl border transition-all duration-300 snap-center ios-press"
              :class="selDate===d.date ? 'bg-sky-500 border-sky-500 shadow-lg shadow-sky-200' : 'bg-white border-slate-100 text-slate-400'">
              <span class="text-[10px] font-bold uppercase tracking-wider" :class="selDate===d.date?'text-sky-100':'opacity-60'">{{ d.short.split('/')[1] }}</span>
              <span class="text-lg font-black leading-none mt-0.5" :class="selDate===d.date?'text-white':'text-slate-600'">{{ d.short.split('/')[0] }}</span>
            </button>
          </div>
          <div class="text-center mt-2">
             <span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-1 rounded-full">{{ getDayInfo(selDate) }}</span>
          </div>
        </div>

        <div class="px-5 relative min-h-[300px]">
          <div class="timeline-line"></div>

          <div v-if="isLoading && itinerary.length===0" class="pl-8 space-y-8 mt-4">
             <div v-for="i in 3" class="h-24 bg-slate-100 rounded-2xl animate-pulse"></div>
          </div>

          <div v-else class="space-y-6">
             <div v-for="evt in getEvents(selDate)" :key="evt.row" 
                  class="relative pl-8 group ios-press"
                  :class="{'opacity-60': isItemPending(evt.row)}"
                  @click="openEditItin(evt)">
                
                <div class="absolute left-0 top-1 w-12 text-right">
                   <div class="w-3 h-3 rounded-full border-2 bg-white absolute right-[-5px] top-1.5 z-10"
                        :class="{'border-sky-500': evt.category==='äº¤é€š', 'border-amber-400': evt.category==='ä½å®¿', 'border-purple-400': evt.category==='æ™¯é»', 'border-orange-400': evt.category==='é£²é£Ÿ', 'border-slate-400': evt.category==='å…¶ä»–'}"></div>
                </div>

                <div class="glass-card p-4 rounded-2xl border-l-0 relative overflow-hidden transition-all duration-300 hover:bg-white/90">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-black tracking-wider text-slate-400 uppercase">
                          {{ evt.startTime }} <span v-if="evt.endTime">- {{ evt.endTime }}</span>
                        </span>
                        <span :class="['tag', 
                            evt.category==='äº¤é€š'?'bg-sky-50 text-sky-600 border-sky-100':
                            evt.category==='ä½å®¿'?'bg-amber-50 text-amber-600 border-amber-100':
                            evt.category==='æ™¯é»'?'bg-purple-50 text-purple-600 border-purple-100':
                            evt.category==='é£²é£Ÿ'?'bg-orange-50 text-orange-600 border-orange-100':
                            'bg-slate-50 text-slate-500 border-slate-100']">
                            {{ evt.category }}
                        </span>
                    </div>

                    <h3 class="font-bold text-slate-800 text-lg leading-tight mb-1">{{ evt.title }}</h3>
                    
                    <div v-if="evt.location" class="flex items-center gap-1 mb-2">
                        <span class="text-xs text-slate-500 truncate">ğŸ“ {{ evt.location }}</span>
                    </div>

                    <img v-if="evt.imgUrl" :src="evt.imgUrl" loading="lazy" 
                         class="w-full h-32 object-cover rounded-lg mb-2 border border-slate-100/50 shadow-sm swipe-protected"
                         @click.stop="viewImage(evt.imgUrl)">

                    <p v-if="evt.note" class="text-sm text-slate-600 leading-relaxed opacity-90 line-clamp-2 allow-select">{{ evt.note }}</p>

                    <div class="absolute right-2 bottom-2 opacity-0 group-hover:opacity-100 transition-opacity">
                         <span class="text-[10px] text-slate-300">Tap to Edit</span>
                    </div>
                </div>
             </div>

             <div class="pl-8 pt-4">
               <button @click="openAddItin" class="w-full py-4 rounded-2xl border-2 border-dashed border-slate-200 text-slate-400 font-bold text-sm hover:bg-slate-50 hover:border-slate-300 transition ios-press flex items-center justify-center gap-2 swipe-protected">
                 <span class="text-xl">+</span> Add Activity
               </button>
             </div>
          </div>
        </div>
      </div>

      <div v-else-if="tab==='expense'" key="expense" class="px-5 pb-10">
        
        <div class="glass-card p-5 rounded-3xl shadow-lg mb-6 swipe-protected relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-sky-400 to-blue-500"></div>
            
            <div class="flex items-center gap-2 mb-4">
                <select v-model="newExp.currency" class="bg-slate-100 text-slate-700 font-bold text-xs rounded-lg px-2 py-1 outline-none">
                    <option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option><option>GBP</option><option>AED</option>
                </select>
                <div class="flex-1 text-right">
                    <input type="number" v-model="newExp.amount" placeholder="0" 
                           class="w-full bg-transparent text-right text-4xl font-black text-slate-800 outline-none placeholder-slate-200 font-mono">
                </div>
            </div>
            <div v-if="newExp.amount && newExp.currency !== 'NTD'" class="text-right text-[10px] text-slate-400 font-bold mb-4">
                â‰ˆ NT$ {{ formatNumber(Math.round(newExp.amount * rates[newExp.currency])) }}
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <select v-model="newExp.payer" class="glass-input h-10 px-3 rounded-xl text-xs font-bold text-slate-600 outline-none">
                    <option value="" disabled selected>èª°ä»˜éŒ¢</option><option>å®¶é½Š</option><option>äº­ç©</option><option>åª½åª½</option>
                </select>
                <select v-model="newExp.item" class="glass-input h-10 px-3 rounded-xl text-xs font-bold text-slate-600 outline-none">
                    <option value="" disabled selected>é …ç›®</option>
                    <option>æ—©é¤</option><option>åˆé¤</option><option>æ™šé¤</option><option>é›¶é£Ÿ</option><option>ä½å®¿</option>
                    <option>äº¤é€šï¼ˆæ©Ÿç¥¨ï¼‰</option><option>äº¤é€šï¼ˆç§Ÿè»Šï¼‰</option><option>äº¤é€šï¼ˆæ²¹éŒ¢ï¼‰</option><option>ç´€å¿µå“</option><option>é–€ç¥¨</option><option>å…¶ä»–</option>
                </select>
            </div>

            <input v-model="newExp.note" placeholder="å‚™è¨»..." class="w-full glass-input px-4 py-3 rounded-xl text-sm mb-4 outline-none">

            <div class="bg-white/50 p-3 rounded-xl mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Shared By</span>
                    <button @click="toggleSelectAll" class="text-[10px] font-bold text-sky-600">All</button>
                </div>
                <div class="flex gap-2">
                    <label v-for="m in members" :key="m" 
                           class="flex-1 py-2 text-center rounded-lg text-xs font-bold border transition cursor-pointer"
                           :class="newExp.involved.includes(m) ? 'bg-sky-500 text-white border-sky-500 shadow-md' : 'bg-white text-slate-400 border-slate-200'">
                        <input type="checkbox" :value="m" v-model="newExp.involved" class="hidden">{{ m }}
                    </label>
                </div>
            </div>

            <button @click="submitExp" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-slate-200 ios-press">
                ç¢ºèªè¨˜å¸³
            </button>
        </div>

        <div class="space-y-3">
            <h3 class="font-bold text-slate-400 text-xs uppercase tracking-widest pl-2">Recent</h3>
            
            <div v-for="exp in expenses.slice(0, 10)" :key="exp.row" 
                 @click="openEditExp(exp)"
                 class="glass-card p-4 rounded-2xl flex justify-between items-center ios-press"
                 :class="{'opacity-70 border-dashed border-amber-300': isItemPending(exp.row)}">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg bg-white shadow-sm">
                        {{ exp.item.includes('é£Ÿ') ? 'ğŸ”' : (exp.item.includes('äº¤é€š') ? 'âœˆï¸' : (exp.item.includes('ä½') ? 'ğŸ¨' : 'ğŸ›ï¸')) }}
                    </div>
                    <div>
                        <div class="font-bold text-slate-800 text-sm">{{ exp.note || exp.item }}</div>
                        <div class="text-[10px] text-slate-400 font-mono">{{ exp.date.slice(5) }} Â· {{ exp.payer }}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-slate-800 font-mono">{{ formatNumber(exp.amount) }} <span class="text-[10px]">{{ exp.currency }}</span></div>
                    <div v-if="exp.currency!=='NTD'" class="text-[10px] text-slate-400">â‰ˆ {{ formatNumber(getAmountTWD(exp)) }}</div>
                </div>
            </div>
        </div>
      </div>

      <div v-else-if="tab==='analysis'" key="analysis" class="px-5 pb-10">
         
         <div class="flex justify-between items-center mb-4 swipe-protected">
             <h2 class="font-bold text-lg text-slate-700">Overview</h2>
             <button @click="openRateModal" class="bg-white px-3 py-1.5 rounded-full text-xs font-bold shadow-sm border text-slate-600">åŒ¯ç‡è¨­å®š</button>
         </div>

         <div class="relative overflow-hidden rounded-[2rem] bg-slate-900 p-6 text-white shadow-xl mb-6">
            <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500 rounded-full blur-[80px] opacity-20 transform translate-x-1/2 -translate-y-1/2"></div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">å‰©é¤˜é ç®—</div>
                        <div class="text-3xl font-black tracking-tight font-mono">
                            ${{ formatNumber(Math.round(500000 - publicSpent)) }}
                        </div>
                    </div>
                    <div class="text-right">
                         <div class="text-slate-400 text-[10px] font-bold">ç¸½é ç®—</div>
                         <div class="font-mono text-sm font-bold opacity-80">$500,000</div>
                    </div>
                </div>
                
                <div class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden mb-2">
                    <div class="bg-gradient-to-r from-sky-400 to-blue-500 h-full rounded-full transition-all duration-1000" :style="{width: Math.min((publicSpent/500000)*100, 100) + '%'}"></div>
                </div>
                <div class="text-right text-[10px] font-bold text-sky-300">å·²ä½¿ç”¨ {{ Math.round(publicSpent/500000*100) }}%</div>
            </div>
         </div>

         <div class="glass-card p-6 rounded-3xl mb-6 relative">
             <h3 class="font-bold text-slate-800 mb-4">æ¶ˆè²»åˆ†ä½ˆ</h3>
             <div class="h-48 relative">
                <canvas id="expenseChart"></canvas>
                <div v-if="chartBusy" class="absolute inset-0 flex items-center justify-center bg-white/50 text-xs font-bold">Loading...</div>
             </div>
         </div>

         <div class="glass-card p-6 rounded-3xl">
             <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">åˆ†å¸³çµç®—</h3>
             <div v-if="debts.length === 0" class="text-center text-slate-400 text-xs py-4">ç›®å‰æ²’æœ‰æ¬ æ¬¾ ğŸ‰</div>
             <div v-for="d in debts" :key="d.from+d.to" class="flex items-center justify-between py-2 border-b border-dashed border-slate-100 last:border-0">
                 <div class="flex items-center gap-2 text-sm">
                     <span class="font-bold text-slate-700">{{ d.from }}</span>
                     <span class="text-[10px] text-slate-400">çµ¦</span>
                     <span class="font-bold text-slate-700">{{ d.to }}</span>
                 </div>
                 <div class="font-mono font-bold text-sky-600">NT$ {{ formatNumber(d.amount) }}</div>
             </div>
         </div>
         
         <div class="h-10"></div>
      </div>

    </Transition>
  </div>

  <nav class="fixed bottom-0 left-0 right-0 z-40 glass-tabbar safe-pb swipe-protected">
    <div class="flex justify-around items-center h-[60px]">
      <button @click="tab='itinerary'" class="flex-1 flex flex-col items-center justify-center gap-1 group">
        <div class="w-12 h-8 rounded-full flex items-center justify-center transition-all duration-300" 
             :class="tab==='itinerary' ? 'bg-sky-100 text-sky-600' : 'text-slate-400 group-hover:bg-slate-50'">
           <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
        </div>
        <span class="text-[10px] font-bold" :class="tab==='itinerary' ? 'text-sky-600' : 'text-slate-400'">è¡Œç¨‹</span>
      </button>

      <button @click="tab='expense'" class="flex-1 flex flex-col items-center justify-center gap-1 group">
        <div class="w-12 h-8 rounded-full flex items-center justify-center transition-all duration-300"
             :class="tab==='expense' ? 'bg-sky-100 text-sky-600' : 'text-slate-400 group-hover:bg-slate-50'">
           <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </div>
        <span class="text-[10px] font-bold" :class="tab==='expense' ? 'text-sky-600' : 'text-slate-400'">è¨˜å¸³</span>
      </button>

      <button @click="changeTabToAnalysis" class="flex-1 flex flex-col items-center justify-center gap-1 group">
        <div class="w-12 h-8 rounded-full flex items-center justify-center transition-all duration-300"
             :class="tab==='analysis' ? 'bg-sky-100 text-sky-600' : 'text-slate-400 group-hover:bg-slate-50'">
           <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></svg>
        </div>
        <span class="text-[10px] font-bold" :class="tab==='analysis' ? 'text-sky-600' : 'text-slate-400'">åˆ†æ</span>
      </button>
    </div>
  </nav>

  <Transition name="fade">
    <div v-if="showItinModal" class="bottom-sheet-overlay" @click="showItinModal=false"></div>
  </Transition>
  <Transition name="slide-up">
    <div v-if="showItinModal" class="bottom-sheet swipe-protected" @click.stop>
      <div class="w-full flex justify-center pt-3 pb-1" @click="showItinModal=false">
         <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
      </div>
      
      <div class="px-6 py-4 border-b border-slate-50 flex justify-between items-center">
         <h3 class="font-black text-xl text-slate-800">{{ isEditing ? 'Edit Activity' : 'New Activity' }}</h3>
         <button @click="showItinModal=false" class="bg-slate-100 rounded-full w-8 h-8 font-bold text-slate-500">âœ•</button>
      </div>

      <div class="overflow-y-auto p-6 space-y-5">
         <div class="flex gap-4">
             <div class="flex-1">
                 <label class="text-[10px] font-bold text-slate-400 uppercase">Start</label>
                 <input type="time" v-model="itinForm.startTime" class="w-full glass-input h-12 rounded-xl px-3 font-bold mt-1">
             </div>
             <div class="flex-1">
                 <label class="text-[10px] font-bold text-slate-400 uppercase">End</label>
                 <input type="time" v-model="itinForm.endTime" class="w-full glass-input h-12 rounded-xl px-3 font-bold mt-1">
             </div>
         </div>

         <div>
             <label class="text-[10px] font-bold text-slate-400 uppercase">Category</label>
             <div class="flex gap-2 mt-1 overflow-x-auto no-scrollbar py-1">
                 <button v-for="c in ['æ™¯é»','é£²é£Ÿ','äº¤é€š','ä½å®¿','å…¶ä»–']" :key="c" @click="itinForm.category=c"
                         class="px-4 py-2 rounded-full text-xs font-bold border transition whitespace-nowrap"
                         :class="itinForm.category===c ? 'bg-sky-500 text-white border-sky-500' : 'bg-white text-slate-500 border-slate-200'">
                    {{c}}
                 </button>
             </div>
         </div>

         <div class="space-y-3">
             <input v-model="itinForm.title" placeholder="What are we doing?" class="w-full glass-input h-12 rounded-xl px-4 font-bold text-slate-800">
             <input v-model="itinForm.location" placeholder="ğŸ“ Location" class="w-full glass-input h-12 rounded-xl px-4 text-sm">
             <input v-model="itinForm.link" placeholder="ğŸ”— Link" class="w-full glass-input h-12 rounded-xl px-4 text-sm text-blue-500">
         </div>

         <div>
            <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Photo</label>
            <div class="relative w-full h-32 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 flex items-center justify-center overflow-hidden">
                <img v-if="itinForm.imgUrl" :src="itinForm.imgUrl" class="w-full h-full object-cover">
                <div v-else class="text-slate-400 text-xs font-bold flex flex-col items-center">
                    <span>ğŸ“· Tap to upload</span>
                </div>
                <input type="file" accept="image/*" @change="handleImageUpload" class="absolute inset-0 opacity-0 cursor-pointer">
                <button v-if="itinForm.imgUrl" @click.prevent="removeImage" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 text-xs">âœ•</button>
            </div>
         </div>

         <textarea v-model="itinForm.note" rows="3" placeholder="Notes..." class="w-full glass-input rounded-xl p-4 text-sm"></textarea>
         
         <div class="flex gap-3 pt-4">
             <button v-if="isEditing" @click="deleteItin(itinForm)" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold">Delete</button>
             <button @click="submitItin" class="flex-[2] bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">Save</button>
         </div>
      </div>
    </div>
  </Transition>

  <Transition name="fade">
    <div v-if="showExpModal" class="bottom-sheet-overlay" @click="showExpModal=false"></div>
  </Transition>
  <Transition name="slide-up">
    <div v-if="showExpModal" class="bottom-sheet swipe-protected" @click.stop>
       <div class="w-full flex justify-center pt-3 pb-1" @click="showExpModal=false"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
       
       <div class="px-6 py-4 flex justify-between items-center">
         <h3 class="font-black text-xl text-slate-800">Edit Expense</h3>
         <button @click="showExpModal=false" class="bg-slate-100 rounded-full w-8 h-8 font-bold text-slate-500">âœ•</button>
       </div>

       <div class="p-6 space-y-4 overflow-y-auto">
          <div class="flex gap-2">
             <select v-model="editExpForm.currency" class="bg-slate-100 rounded-lg px-2 font-bold text-xs"><option>NTD</option><option>NOK</option><option>ISK</option><option>EUR</option></select>
             <input type="number" v-model="editExpForm.amount" class="flex-1 text-right text-2xl font-bold border-b border-slate-200 outline-none pb-1">
          </div>
          <div class="grid grid-cols-2 gap-3">
             <select v-model="editExpForm.payer" class="glass-input h-10 px-2 rounded-lg font-bold text-xs"><option>å®¶é½Š</option><option>äº­ç©</option><option>åª½åª½</option></select>
             <select v-model="editExpForm.item" class="glass-input h-10 px-2 rounded-lg font-bold text-xs"><option>æ—©é¤</option><option>åˆé¤</option><option>ä½å®¿</option><option>äº¤é€šï¼ˆæ©Ÿç¥¨ï¼‰</option><option>å…¶ä»–</option></select>
          </div>
          <input v-model="editExpForm.note" class="w-full glass-input h-10 px-3 rounded-lg text-sm" placeholder="å‚™è¨»">
          
          <div class="bg-slate-50 p-3 rounded-lg">
             <div class="flex justify-between mb-2"><span class="text-[10px] font-bold text-slate-400">SHARED BY</span><button @click="toggleSelectAllEdit" class="text-[10px] text-sky-500 font-bold">ALL</button></div>
             <div class="flex gap-2">
                 <label v-for="m in members" :key="m" class="flex-1 border rounded px-2 py-2 text-center text-xs font-bold transition" 
                        :class="(editExpForm.involved||[]).includes(m)?'bg-white border-sky-400 text-sky-600 shadow-sm':'text-slate-400 border-slate-200'">
                     <input type="checkbox" :value="m" v-model="editExpForm.involved" class="hidden">{{m}}
                 </label>
             </div>
          </div>
          
          <div class="flex gap-3 pt-2">
             <button @click="deleteExp(editExpForm)" class="flex-1 bg-red-50 text-red-500 py-3 rounded-xl font-bold">Delete</button>
             <button @click="submitEditExp" class="flex-[2] bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">Update</button>
          </div>
       </div>
    </div>
  </Transition>

  <Transition name="fade">
    <div v-if="showRateModal" class="fixed inset-0 z-50 flex items-center justify-center p-6 swipe-protected">
       <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" @click="showRateModal=false"></div>
       <div class="bg-white w-full max-w-xs rounded-3xl p-6 relative z-10 shadow-2xl">
          <h3 class="font-bold text-lg mb-4 text-center">Exchange Rates</h3>
          <div class="space-y-3">
             <div v-for="c in ['NOK','ISK','EUR','GBP','AED']" :key="c" class="flex items-center justify-between">
                <span class="font-bold text-slate-400 w-10">{{c}}</span>
                <input type="number" v-model="tempRates[c]" class="w-24 text-right bg-slate-50 rounded p-2 font-mono font-bold border border-slate-100 focus:border-sky-400 outline-none">
             </div>
          </div>
          <button @click="saveRates" class="w-full mt-6 bg-slate-900 text-white py-3 rounded-xl font-bold">Save</button>
       </div>
    </div>
  </Transition>

  <Transition name="fade">
    <div v-if="showImgViewer" class="img-viewer" @click="closeImgViewer"
         @touchstart="handleImgTouchStart" @touchmove="handleImgTouchMove" @touchend="handleImgTouchEnd">
        
        <button class="absolute top-12 right-5 w-10 h-10 bg-white/20 rounded-full text-white flex items-center justify-center backdrop-blur-md z-50 border border-white/20" @click.stop="closeImgViewer">âœ•</button>
        
        <div v-if="imgGesture.scale===1" class="absolute top-16 text-white/50 text-xs font-bold tracking-widest px-3 py-1 bg-black/30 rounded-full backdrop-blur pointer-events-none" :style="{opacity: imgGesture.isPulling ? 1 : 0}">RELEASE TO CLOSE</div>

        <img :src="viewingImg" ref="imgViewerEl" class="max-w-full max-h-full object-contain transition-transform duration-0 ease-linear" @dblclick="toggleZoom" @click.stop style="will-change: transform;">
    </div>
  </Transition>

</div>

<script>
// Logic Context (Preserved)
const YOUR_GAS_URL = 'https://script.google.com/macros/s/AKfycbz6PZtqLJzlS2a71R-RfZjpJCuqJVPoP7RuNxEe74mS_uvxBejMNGKboFSn2ArNnXAu/exec';

// Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

// API Helper
async function callApi(action, data = null, method = 'GET') {
  const options = { method };
  if (method === 'POST') {
    options.body = JSON.stringify({ action, data });
    options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
  }
  let url = YOUR_GAS_URL;
  if (method === 'GET') url += `?action=${action}`;
  try {
    const response = await fetch(url, options);
    if (!response.ok) throw new Error("Network error");
    return await response.json();
  } catch(e) { return null; }
}

const { createApp, ref, computed, onMounted, nextTick, watch, onBeforeUnmount } = Vue;

createApp({
  setup() {
    const tab = ref('itinerary');
    const isLoading = ref(true);
    const isFirstLoad = ref(true);
    const isPullRefreshing = ref(false);
    const isOnline = ref(navigator.onLine);
    const isSyncing = ref(false);
    const syncQueue = ref([]);
    const scrollY = ref(0); // Track scroll for header effect

    const members = ref([]);
    const expenses = ref([]);
    const itinerary = ref([]);
    const rates = ref({});

    const dateContainer = ref(null);
    const scrollContainer = ref(null);

    const todayDate = ref('');
    const todayWeekday = ref('');

    // --- Image Viewer & Gestures ---
    const showImgViewer = ref(false);
    const viewingImg = ref('');
    const imgViewerEl = ref(null);
    const imgGesture = ref({ startX: 0, startY: 0, currentY: 0, scale: 1, isPulling: false, isZooming: false, startDistance: 0 });

    const getDistance = (touches) => Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);

    const handleImgTouchStart = (e) => {
        if (e.touches.length === 2) {
            imgGesture.value.isZooming = true;
            imgGesture.value.startDistance = getDistance(e.touches);
        } else if (e.touches.length === 1) {
            imgGesture.value.startX = e.touches[0].clientX;
            imgGesture.value.startY = e.touches[0].clientY;
            imgGesture.value.isPulling = false;
        }
    };

    const handleImgTouchMove = (e) => {
        if(!showImgViewer.value) return;
        e.preventDefault(); 
        if (e.touches.length === 2 && imgGesture.value.isZooming) {
            const dist = getDistance(e.touches);
            const scale = Math.max(1, Math.min(imgGesture.value.scale * (dist / imgGesture.value.startDistance), 4));
            if(imgViewerEl.value) imgViewerEl.value.style.transform = `scale(${scale})`;
            imgGesture.value.tempScale = scale;
        } else if (e.touches.length === 1 && imgGesture.value.scale === 1) {
            const dy = e.touches[0].clientY - imgGesture.value.startY;
            if (dy > 0) {
                imgGesture.value.currentY = dy;
                imgGesture.value.isPulling = true;
                if(imgViewerEl.value) imgViewerEl.value.style.transform = `translateY(${dy}px) scale(${1 - dy/1000})`;
            }
        }
    };

    const handleImgTouchEnd = (e) => {
        if (imgGesture.value.isZooming) {
            if (imgGesture.value.tempScale) imgGesture.value.scale = imgGesture.value.tempScale;
            imgGesture.value.isZooming = false;
            if (imgGesture.value.scale < 1) { imgGesture.value.scale = 1; resetImgTransform(); }
        } else if (imgGesture.value.isPulling) {
            if (imgGesture.value.currentY > 100) closeImgViewer();
            else resetImgTransform();
            imgGesture.value.isPulling = false;
        }
    };

    const resetImgTransform = () => {
        if (imgViewerEl.value) imgViewerEl.value.style.transform = `scale(${imgGesture.value.scale})`;
    };

    const toggleZoom = () => {
        imgGesture.value.scale = (imgGesture.value.scale > 1) ? 1 : 2.5;
        resetImgTransform();
    };

    // --- App Logic ---
    const tripStatus = computed(() => {
      const now = new Date();
      const start = new Date('2026-08-30');
      if (now < start) return `å€’æ•¸ ${Math.ceil((start - now)/86400000)} å¤©`;
      return 'ON TRIP';
    });

    const tripDates = [];
    const startDate = new Date('2026-08-30');
    for (let d = new Date(startDate); d <= new Date('2026-09-26'); d.setDate(d.getDate()+1)) {
      tripDates.push({ date: d.toISOString().split('T')[0], short: (d.getMonth()+1)+'/'+d.getDate() });
    }
    const selDate = ref(tripDates[0].date);
    
    // UI State
    const showRateModal = ref(false);
    const showItinModal = ref(false);
    const showExpModal = ref(false);
    const isEditing = ref(false);
    const itinForm = ref({ row: null, startTime: '09:00', endTime: '', category: 'æ™¯é»', title: '', location: '', link: '', note: '', imgUrl: '' });
    const newExp = ref({ payer: '', location: '', item: '', payment: '', currency: 'NTD', amount: null, involved: [], note: '' });
    const editExpForm = ref({});
    const tempRates = ref({});

    // Watchers
    watch(() => newExp.value.payer, (v) => { if (v) newExp.value.involved = [v]; });
    
    // Pull Refresh Logic
    const pullDistance = ref(0);
    const attachGestureListeners = () => {
      const el = scrollContainer.value;
      if (!el) return;
      
      let startY = 0;
      let pulling = false;

      el.addEventListener('touchstart', (e) => {
        if (el.scrollTop <= 0) {
            startY = e.touches[0].clientY;
            pulling = true;
        }
      }, { passive: true });

      el.addEventListener('touchmove', (e) => {
        if (!pulling) return;
        const y = e.touches[0].clientY;
        const dy = y - startY;
        if (dy > 0 && el.scrollTop <= 0) {
            // e.preventDefault(); // Chrome requires passive:false for preventDefault
            pullDistance.value = Math.min(dy * 0.4, 80); // Damping
        } else {
            pullDistance.value = 0;
        }
      }, { passive: true });

      el.addEventListener('touchend', () => {
        if (pullDistance.value > 60) {
            isPullRefreshing.value = true;
            loadData();
        }
        pulling = false;
        pullDistance.value = 0;
      }, { passive: true });
    };

    // Scroll Handler for Header
    const handleScroll = (e) => {
        scrollY.value = e.target.scrollTop;
    };

    // --- Data Handling ---
    const saveLocal = () => {
        localStorage.setItem('tripData_v2', JSON.stringify({ expenses: expenses.value, itinerary: itinerary.value, members: members.value, rates: rates.value }));
        localStorage.setItem('syncQueue_v2', JSON.stringify(syncQueue.value));
    };

    const loadLocal = () => {
        const d = localStorage.getItem('tripData_v2');
        if(d) {
            const p = JSON.parse(d);
            expenses.value = p.expenses||[]; itinerary.value = p.itinerary||[]; members.value = p.members||[]; rates.value = p.rates||{};
            return true;
        }
        return false;
    };

    const handleCRUD = async (type, action, data) => {
       if (navigator.onLine) {
         isSyncing.value = true;
         try {
           const suffix = (type==='itin'?'Itinerary':'Expense');
           const res = await callApi(action==='delete'?'deleteRow':action+suffix, data, 'POST');
           if(res && res.expenses) {
               expenses.value = res.expenses; itinerary.value = res.itinerary;
           }
         } catch (e) { syncQueue.value.push({ type, action, data }); }
         isSyncing.value = false;
       } else { syncQueue.value.push({ type, action, data }); }
       saveLocal();
    };

    const loadData = async () => {
      if (!isPullRefreshing.value) isLoading.value = true;
      loadLocal();
      if(navigator.onLine) {
         try {
            const res = await callApi('getData');
            if(res && res.expenses) {
                expenses.value = res.expenses; itinerary.value = res.itinerary; members.value = res.members; rates.value = res.rates;
                saveLocal();
            }
         } catch(e){}
      }
      isLoading.value = false; isPullRefreshing.value = false;
      if(tab.value === 'analysis') scheduleRenderChart();
    };

    // --- Utility ---
    const selectDate = (d) => { 
        selDate.value = d;
        nextTick(() => {
            const btn = document.getElementById('date-btn-'+d);
            if(btn) btn.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
        });
    };
    const getEvents = (d) => itinerary.value.filter(e => e.date === d).sort((a,b)=>a.startTime.localeCompare(b.startTime));
    const formatNumber = (n) => String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    const getAmountTWD = (exp) => Math.round(exp.amount * (rates.value[exp.currency] || 1));
    const isItemPending = (row) => syncQueue.value.some(j => j.data.row === row);

    // Analysis Logic
    const publicSpent = computed(() => expenses.value.reduce((sum, e) => {
        const amt = getAmountTWD(e);
        if(!e.involved?.length) return sum;
        let bill = 0; const share = amt/e.involved.length;
        if(e.involved.includes('å®¶é½Š')) bill+=share;
        if(e.involved.includes('äº­ç©')) bill+=share;
        return sum+bill;
    },0));

    const debts = computed(() => {
        if(!members.value.length) return [];
        const bal={}; members.value.forEach(m=>bal[m]=0);
        expenses.value.forEach(e=>{
            const amt=getAmountTWD(e); const inv=e.involved||[];
            if(inv.length){ bal[e.payer]+=amt; inv.forEach(p=>bal[p]-=amt/inv.length); }
        });
        let d=[],c=[]; for(let m in bal){ if(bal[m]<-1) d.push({p:m,a:bal[m]}); if(bal[m]>1) c.push({p:m,a:bal[m]}); }
        d.sort((a,b)=>a.a-b.a); c.sort((a,b)=>b.a-a.a);
        const res=[]; let i=0,j=0;
        while(i<d.length && j<c.length){
            const amt=Math.min(Math.abs(d[i].a), c[j].a);
            res.push({from:d[i].p, to:c[j].p, amount:Math.round(amt)});
            d[i].a+=amt; c[j].a-=amt;
            if(Math.abs(d[i].a)<1) i++; if(c[j].a<1) j++;
        }
        return res;
    });

    // Chart
    let chartInstance = null;
    const chartBusy = ref(false);
    const scheduleRenderChart = () => {
        if(tab.value!=='analysis') return;
        chartBusy.value = true;
        setTimeout(() => {
            const ctx = document.getElementById('expenseChart');
            if(!ctx) return;
            const stats = {};
            expenses.value.forEach(e => {
                const k = e.item || 'å…¶ä»–';
                stats[k] = (stats[k]||0) + getAmountTWD(e);
            });
            const labels = Object.keys(stats);
            const data = Object.values(stats);
            
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels, 
                    datasets: [{ 
                        data, 
                        backgroundColor: ['#38bdf8','#818cf8','#c084fc','#f472b6','#fb7185','#22d3ee'], 
                        borderWidth: 0 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%',
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } 
                }
            });
            chartBusy.value = false;
        }, 200);
    };

    // Actions
    const openAddItin = () => { itinForm.value={row:null,startTime:'09:00',endTime:'',category:'æ™¯é»',title:'',imgUrl:''}; isEditing.value=false; showItinModal.value=true; };
    const openEditItin = (e) => { itinForm.value={...e}; isEditing.value=true; showItinModal.value=true; };
    const submitItin = () => {
        if(!itinForm.value.title) return;
        const p = { ...itinForm.value, row: isEditing.value?itinForm.value.row:Date.now(), date: selDate.value };
        if(isEditing.value) { const i=itinerary.value.findIndex(x=>x.row===p.row); if(i!==-1) itinerary.value[i]=p; handleCRUD('itin','edit',p); }
        else { itinerary.value.push(p); handleCRUD('itin','add',p); }
        showItinModal.value=false;
    };
    const deleteItin = (e) => { if(confirm('Del?')){ itinerary.value=itinerary.value.filter(x=>x.row!==e.row); handleCRUD('itin','delete',{row:e.row,sheetName:'Itinerary'}); showItinModal.value=false; }};

    const submitExp = () => {
        if(!newExp.value.amount || !newExp.value.item) return;
        const p = { ...newExp.value, row: Date.now(), date: new Date().toISOString().split('T')[0] };
        expenses.value.unshift(p);
        handleCRUD('exp','add',p);
        newExp.value.amount=null; newExp.value.note=''; alert('Saved!');
    };
    const openEditExp = (e) => { editExpForm.value=JSON.parse(JSON.stringify(e)); showExpModal.value=true; };
    const submitEditExp = () => {
        const i=expenses.value.findIndex(e=>e.row===editExpForm.value.row);
        if(i!==-1) expenses.value[i]=editExpForm.value;
        handleCRUD('exp','edit',editExpForm.value);
        showExpModal.value=false;
    };
    const deleteExp = (e) => { if(confirm('Del?')){ expenses.value=expenses.value.filter(x=>x.row!==e.row); handleCRUD('exp','delete',{row:e.row,sheetName:'Expenses'}); showExpModal.value=false; }};
    
    // Image Upload
    const handleImageUpload = (e) => {
        const f = e.target.files[0]; if(!f)return;
        const r = new FileReader();
        r.onload = (evt) => itinForm.value.imgUrl = evt.target.result;
        r.readAsDataURL(f);
    };
    const removeImage = () => itinForm.value.imgUrl = '';
    const viewImage = (u) => { viewingImg.value=u; showImgViewer.value=true; imgGesture.value.scale=1; };
    const closeImgViewer = () => { showImgViewer.value=false; };

    // Init
    onMounted(async () => {
        const d = new Date(); todayDate.value = (d.getMonth()+1)+'.'+d.getDate(); 
        todayWeekday.value = ['SUN','MON','TUE','WED','THU','FRI','SAT'][d.getDay()];
        await nextTick();
        loadData();
        attachGestureListeners();
    });

    watch(tab, (v) => { if(v==='analysis') scheduleRenderChart(); });

    return {
       tab, isLoading, isOnline, isSyncing, syncQueue, tripStatus, tripDates, selDate, selectDate, getDayInfo, getEvents,
       itinerary, expenses, rates, members, 
       newExp, editExpForm, itinForm, isEditing, showItinModal, showExpModal, showRateModal, tempRates,
       openAddItin, openEditItin, submitItin, deleteItin, submitExp, openEditExp, submitEditExp, deleteExp,
       handleImageUpload, removeImage, viewImage, closeImgViewer, showImgViewer, viewingImg, imgViewerEl,
       handleImgTouchStart, handleImgTouchMove, handleImgTouchEnd, imgGesture, toggleZoom,
       formatNumber, getAmountTWD, publicSpent, debts, isItemPending,
       scrollY, handleScroll, dateContainer, scrollContainer, pullDistance, isPullRefreshing,
       todayDate, todayWeekday,
       openRateModal: () => { tempRates.value={...rates.value}; showRateModal.value=true; },
       saveRates: () => { rates.value={...tempRates.value}; saveLocal(); showRateModal.value=false; callApi('updateRates',rates.value,'POST'); },
       confirmClearSync: () => { if(confirm('Clear sync queue?')) syncQueue.value=[]; saveLocal(); },
       toggleSelectAll: () => newExp.value.involved = (newExp.value.involved.length===members.value.length)?[]:[...members.value],
       toggleSelectAllEdit: () => editExpForm.value.involved = (editExpForm.value.involved.length===members.value.length)?[]:[...members.value],
       chartBusy, changeTabToAnalysis: () => tab.value='analysis'
    };
  }
}).mount('#app');
</script>
</body>
</html>
